// jquery.pjax.js
// copyright chris wanstrath
// https://github.com/defunkt/jquery-pjax
(function(a){function b(b,c,d){d=g(c,d);var e=b.currentTarget;if(e.tagName.toUpperCase()!=="A")throw"$.fn.pjax or $.pjax.click requires an anchor element";if(b.which>1||b.metaKey)return;if(location.protocol!==e.protocol||location.host!==e.host)return;if(e.hash&&e.href.replace(e.hash,"")===location.href.replace(location.hash,""))return;var f={url:e.href,container:a(e).attr("data-pjax"),target:e,clickedElement:a(e),fragment:null};return a.pjax(a.extend({},f,d)),b.preventDefault(),!1}function d(){return(new Date).getTime()}function e(a){return a.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function f(a){var b=document.createElement("a");return b.href=a,b}function g(b,c){return b&&c?c.container=b:a.isPlainObject(b)?c=b:c={container:b},c.container&&(c.container=h(c.container)),c}function h(b){b=a(b);if(!b.length)throw"no pjax container for "+b.selector;if(b.selector!==""&&b.context===document)return b;if(b.attr("id"))return a("#"+b.attr("id"));throw"cant get selector for pjax container!"}function i(b,c){var d=a();return b.each(function(){a(this).is(c)&&(d=d.add(this)),d=d.add(c,this)}),d}function j(b,c,d){var f={};f.url=e(c.getResponseHeader("X-PJAX-URL")||d.url);var g=a(b);if(g.length===0)return f;f.title=i(g,"title").last().text();if(d.fragment){var h=i(g,d.fragment).first();h.length&&(f.contents=h.contents(),f.title||(f.title=h.attr("title")||h.data("title")))}else/<html/i.test(b)||(f.contents=g);return f.contents&&(f.contents=f.contents.not("title"),f.contents.find("title").remove()),f.title&&(f.title=a.trim(f.title)),f}a.fn.pjax=function(a,c){return this.live("click.pjax",function(d){return b(d,a,c)})};var c=a.pjax=function(b){function o(b,c){var d=a.Event(b,{relatedTarget:e});return n.trigger(d,c),!d.isDefaultPrevented()}b=a.extend(!0,{},a.ajaxSettings,c.defaults,b),a.isFunction(b.url)&&(b.url=b.url());var e=b.target;!e&&b.clickedElement&&(e=b.clickedElement[0]);var g=f(b.url).hash,i=b.beforeSend,k=b.complete,l=b.success,m=b.error,n=b.context=h(b.container);b.data||(b.data={}),b.data._pjax=n.selector;var p;b.beforeSend=function(a,c){c.timeout>0&&(p=setTimeout(function(){o("pjax:timeout",[a,b])&&a.abort("timeout")},c.timeout),c.timeout=0),a.setRequestHeader("X-PJAX","true"),a.setRequestHeader("X-PJAX-Container",n.selector);var d;if(i){d=i.apply(this,arguments);if(d===!1)return!1}if(!o("pjax:beforeSend",[a,c]))return!1;o("pjax:start",[a,b]),o("start.pjax",[a,b])},b.complete=function(a,c){p&&clearTimeout(p),k&&k.apply(this,arguments),o("pjax:complete",[a,c,b]),o("pjax:end",[a,b]),o("end.pjax",[a,b])},b.error=function(a,c,d){var e=j("",a,b);m&&m.apply(this,arguments);var f=o("pjax:error",[a,c,d,b]);c!=="abort"&&f&&(window.location=e.url)},b.success=function(a,e,f){var h=j(a,f,b);if(!h.contents){window.location=h.url;return}c.state={id:b.id||d(),url:h.url,container:n.selector,fragment:b.fragment,timeout:b.timeout},h.title&&(document.title=h.title),n.html(h.contents),b.replace?window.history.replaceState(c.state,h.title,h.url):b.push&&window.history.pushState(c.state,h.title,h.url),(b.replace||b.push)&&window._gaq&&_gaq.push(["_trackPageview"]),g!==""&&(window.location.href=g),l&&l.apply(this,arguments),o("pjax:success",[a,e,f,b])},c.state||(c.state={id:d(),url:window.location.href,container:n.selector,fragment:b.fragment,timeout:b.timeout},window.history.replaceState(c.state,document.title));var q=c.xhr;return q&&q.readyState<4&&(q.onreadystatechange=a.noop,q.abort()),c.options=b,c.xhr=a.ajax(b),a(document).trigger("pjax",[c.xhr,b]),c.xhr};c.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html"},c.click=b;var k="state"in window.history,l=location.href;a(window).bind("popstate",function(b){var c=!k&&location.href==l;k=!0;if(c)return;var d=b.state;if(d&&d.container){var e=a(d.container);e.length?a.pjax({id:d.id,url:d.url,container:e,push:!1,fragment:d.fragment,timeout:d.timeout}):window.location=location.href}}),a.inArray("state",a.event.props)<0&&a.event.props.push("state"),a.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),a.support.pjax||(a.pjax=function(b){var c=a.isFunction(b.url)?b.url():b.url,d=b.type?b.type.toUpperCase():"GET",e=a("<form>",{method:d==="GET"?"GET":"POST",action:c,style:"display:none"});d!=="GET"&&d!=="POST"&&e.append(a("<input>",{type:"hidden",name:"_method",value:d.toLowerCase()}));var f=b.data;if(typeof f=="string")a.each(f.split("&"),function(b,c){var d=c.split("=");e.append(a("<input>",{type:"hidden",name:d[0],value:d[1]}))});else if(typeof f=="object")for(key in f)e.append(a("<input>",{type:"hidden",name:key,value:f[key]}));a(document.body).append(e),e.submit()},a.pjax.click=a.noop,a.fn.pjax=function(){return this})})(jQuery);