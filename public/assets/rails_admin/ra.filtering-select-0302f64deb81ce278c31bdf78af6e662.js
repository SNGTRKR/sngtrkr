/*
 * RailsAdmin filtering select @VERSION
 *
 * Based on the combobox example from jQuery UI documentation
 * http://jqueryui.com/demos/autocomplete/#combobox
 *
 * License
 *
 * http://www.railsadmin.org
 *
 * Depends:
 *   jquery.ui.core.js
 *   jquery.ui.widget.js
 *   jquery.ui.autocomplete.js
 */
(function(a){a.widget("ra.filteringSelect",{options:{createQuery:function(a){return{query:a}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},_create:function(){var b=this,c=this.element.hide(),d=c.children(":selected"),e=d.val()?d.text():"";this.options.xhr?this.options.source=this.options.remote_source:this.options.source=c.children("option").map(function(){return{label:a(this).text(),value:this.value}}).toArray();var f=a('<div class="input-append filtering-select" style="float:left"></div>'),g=this.input=a('<input type="search">').val(e).addClass("ra-filtering-select-input").attr("style",c.attr("style")).show().autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(d,e){var f=a('<option value="'+e.item.id+'" selected="selected">'+e.item.value+"</option>");c.html(f),b._trigger("selected",d,{item:f}),a(b.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(d,e){if(!e.item){var f=new RegExp("^"+a.ui.autocomplete.escapeRegex(a(this).val())+"$","i"),h=!1;c.children("option").each(function(){if(a(this).text().match(f))return this.selected=h=!0,!1});if(!h||a(this).val()=="")return a(this).val(null),c.html(a('<option value="" selected="selected"></option>')),g.data("autocomplete").term="",a(b.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}});c.attr("placeholder")&&g.attr("placeholder",c.attr("placeholder")),g.data("autocomplete")._renderItem=function(b,c){return a("<li></li>").data("item.autocomplete",c).append(a("<a></a>").html(c.label||c.id)).appendTo(b)};var h=this.button=a('<label class="add-on ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" title="Show All Items" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="ui-button-text">&nbsp;</span></label>').click(function(){if(g.autocomplete("widget").is(":visible")){g.autocomplete("close");return}g.autocomplete("search",""),g.focus()});f.append(g).append(h).insertAfter(c)},_getResultSet:function(b,c,d){var e=new RegExp(a.ui.autocomplete.escapeRegex(b.term),"i");return a.map(c,function(c,f){if((c.id||c.value)&&(d||e.test(c.label)))return{label:c.label?c.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+a.ui.autocomplete.escapeRegex(b.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):c.id,value:c.label||c.id,id:c.id||c.value}})},_getSourceFunction:function(b){var c=this,d=0;return a.isArray(b)?function(a,d){d(c._getResultSet(a,b,!1))}:typeof b=="string"?function(e,f){this.xhr&&this.xhr.abort(),this.xhr=a.ajax({url:b,data:c.options.createQuery(e.term),dataType:"json",autocompleteRequest:++d,success:function(a,b){this.autocompleteRequest===d&&f(c._getResultSet(e,a,!0))},error:function(){this.autocompleteRequest===d&&f([])}})}:b},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),a.Widget.prototype.destroy.call(this)}})})(jQuery);